#!/bin/sh

CMD_NAME=$(basename "$0")

show_help() {
  echo "Usage: ${CMD_NAME} [ls|new|rm|edit]"
}

# デフォルトの挙動いいのあれば採用したい。
if [ "$#" -eq 0 ]; then
  show_help >&2
  exit 1
fi

### サブコマンドを設定
parse() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
    --) shift; ARGS="$@"; break ;;
    -h | --help) FLAG_HELP=1; shift; ARGS="$@"; break ;;
    ls) SUBCOM=ls; shift; ARGS="$@"; break ;;
    new) SUBCOM=new; shift; ARGS="$@"; break ;;
    rm) SUBCOM=rm; shift; ARGS="$@"; break ;;
    edit) SUBCOM=edit; shift; ARGS="$@"; break ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    esac
  done
}
parse "$@"
set -- $ARGS

if [ "${FLAG_HELP}" = "1" ]; then
  show_help >&2
  exit 1
fi

# サブコマンドの準備
BASE="${HOME}/.cont"
NAME=$(echo "${PWD}" | tr '/' '_' | sed 's/^_//')
NAME=$(echo "${NAME}" | tr '[:upper:]' '[:lower:]')
CONF="${BASE}/${NAME}.mk"

mkdir -p "${BASE}"

### サブコマンド：new
if [ "${SUBCOM}" = "new" ]; then
  parse() {
    while [ "$#" -gt 0 ]; do
      case "$1" in
      --) shift; ARGS="$@"; break ;;
      -h | --help) FLAG_HELP=1; shift; ARGS="$@"; break ;;
      -f | --force) FLAG_FORCE=1; shift; ARGS="$@"; ;;
      -d | --dry-run) FLAG_DRY_RUN=1; shift; ARGS="$@"; ;;
      --full) FLAG_FULL=1; shift; ARGS="$@"; ;;
      -i | --image) IMG="$2"; shift 2; ARGS="$@"; ;;
      -v | --vm) VM="$2"; shift 2; ARGS="$@"; ;;
      -p | --port) FLAG_PORT=1; PORT="$2"; shift 2; ARGS="$@"; ;;
      -n | --network) FLAG_NETWORK=1; NW="$2"; shift 2; ARGS="$@"; ;;
      *)
        echo "Unknown option: $1" >&2
        exit 1
        ;;
      esac
    done
  }
  parse "$@"
  set -- $ARGS

  # TODO
  if [ "${FLAG_PORT}" = "1" ]; then
    echo "Error: -p|--port option is not implemented yet" >&2
    exit 1
  fi

  # TODO
  if [ "${FLAG_NETWORK}" = "1" ]; then
    echo "Error: -n|--network option is not implemented yet" >&2
    exit 1
  fi

  if [ "${FLAG_HELP}" = "1" ]; then
    echo "Usage: ${CMD_NAME} new [opts]
options:
  -h              : show help
  -f|--force      : force write
  -d|--dry-run    : dry run (output to stdout)
  --full          : include option targets
  -i|--image image: set image
  -v|--vm vmachine: set virtual machine (default: podman > docker)
  -p|--port port  : set port mapping (not implemented yet)
  -n|--network net: set network options (not implemented yet)" >&2
    exit 1
  fi

  if [ "${FLAG_DRY_RUN}" != "1" ]; then
    if [ -e "${CONF}" ] && [ "${FLAG_FORCE}" != "1" ]; then
      echo "Error: Configuration file already exists: ${CONF}" >&2
      echo "Use -f or --force option to overwrite it." >&2
      exit 1
    fi
  fi

  # 出力先を決定（dry-runの場合は標準出力、そうでない場合はファイル）
  if [ "${FLAG_DRY_RUN}" = "1" ]; then
    OUTPUT="/dev/stdout"
  else
    OUTPUT="${CONF}"
  fi

  # NOTE: 512Bを超えると書き込めない環境を確認している。
  # 一時ファイルを利用せずメモリで完結するよう分割する。
  cat <<EOF > "${OUTPUT}"
VM := ${VM:-podman}
NAME := ${NAME}
IMG := ${IMG:-"${NAME}"}

VOL := -v ./:/app -v /etc/localtime:/etc/localtime:ro
#PORT := -p 8080:80 -p 3000:3000
#NW := --network mynet --network-alias mynet.com
VM_ARGS := \$(VOL) \$(PORT) \$(NW) -w /app --name \$(NAME)

all:
	@cat "$CONF"

build:
	\$(VM) build . -t \$(NAME)
rebuild:
	-cont stop
	-cont rm
	-cont rmi
	cont build
EOF

  cat <<EOF >> "${OUTPUT}"

run:
	\$(VM) run --rm \$(VM_ARGS) -it \$(IMG)
ever:
	if \$(VM) ps -a --filter name=\$(NAME) --format "{{.Names}}" | grep -q \$(NAME); then \\
		\$(VM) start \$(NAME); \\
	else \\
		\$(VM) run \$(VM_ARGS) -itd \$(IMG) bash; \\
	fi
never:
	\$(VM) run --rm \$(VM_ARGS) -itd \$(IMG) bash
EOF
  cat <<EOF >> "${OUTPUT}"

stop:
	\$(VM) stop \$(NAME)
rm:
	\$(VM) rm \$(NAME)
rmi:
	\$(VM) rmi \$(NAME)
bash:
	\$(VM) exec -it \$(NAME) bash
EOF

  if [ "${FLAG_FULL}" = "1" ]; then
    cat <<EOF >> "${OUTPUT}"

#sync-time:
#	podman machine ssh date -u -s "\$\$(date -u +'%Y-%m-%dT%H:%M:%S')"

#proxy:
#	\$(VM) exec -it \$(NAME) socat -v 'tcp4-listen:8443,fork,reuseaddr' 'tcp4:127.0.0.1:443'
EOF
  fi

  exit 0
fi

### サブコマンド：ls (list)
if [ "${SUBCOM}" = "ls" ]; then
  parse() {
    while [ "$#" -gt 0 ]; do
      case "$1" in
      --) shift; ARGS="$@"; break ;;
      -h | --help) FLAG_HELP=1; shift; ARGS="$@"; break ;;
      *)
        # ヘルプ以外の引数はlsコマンドに流す
        ARGS="$@"
        break
        ;;
      esac
    done
  }
  parse "$@"
  set -- $ARGS

  if [ "${FLAG_HELP}" = "1" ]; then
    echo "Usage: ${CMD_NAME} ls [ls-options]
List configuration files in ${BASE}
All arguments except -h/--help are passed to ls command." >&2
    exit 1
  fi

  # lsコマンドに引数を渡して実行
  exec ls "$@" "${BASE}"
fi

### サブコマンド：rm
if [ "${SUBCOM}" = "rm" ]; then
  parse() {
    while [ "$#" -gt 0 ]; do
      case "$1" in
      --) shift; ARGS="$@"; break ;;
      -h | --help) FLAG_HELP=1; shift; ARGS="$@"; break ;;
      *)
        echo "Unknown option: $1" >&2
        exit 1
        ;;
      esac
    done
  }
  parse "$@"
  set -- $ARGS

  if [ "${FLAG_HELP}" = "1" ]; then
    echo "Usage: ${CMD_NAME} rm
Delete configuration file: ${CONF}" >&2
    exit 1
  fi

  if [ ! -e "${CONF}" ]; then
    echo "Error: Configuration file does not exist: ${CONF}" >&2
    exit 1
  fi

  rm -f "${CONF}"
  echo "Deleted: ${CONF}"
  exit 0
fi
